import{Bone,BoxGeometry,Color,CylinderGeometry,Euler,Matrix4,Mesh,MeshBasicMaterial,Object3D,Quaternion,SphereGeometry,Vector3}from"three";const clamp=(t,s,e)=>Math.min(Math.max(t,s),e);class LCache{constructor(){this.threeVector3s=[],this.threeMatrix4s=[],this.threeQuaternions=[],this.threeEulers=[]}allocThreeVector3(){return this.threeVector3s.length>0?this.threeVector3s.pop():new Vector3}freeThreeVector3(t){this.threeVector3s.push(t)}allocThreeMatrix4(){return this.threeMatrix4s.length>0?this.threeMatrix4s.pop():new Matrix4}freeThreeMatrix4(t){this.threeMatrix4s.push(t)}allocThreeQuaternion(){return this.threeQuaternions.length>0?this.threeQuaternions.pop():new Quaternion}freeThreeQuaternion(t){this.threeQuaternions.push(t)}allocThreeEuler(){return this.threeEulers.length>0?this.threeEulers.pop():new Euler}freeThreeEuler(t){this.threeEulers.push(t)}}class ClothHelper extends Object3D{constructor(t,s){super(),this.lCache=new LCache,this.root=t,this.physics=s,this.matrix.copy(t.matrixWorld),this.matrixAutoUpdate=!1,this.materials=[],this.materials.push(new MeshBasicMaterial({color:new Color(16746632),wireframe:!0,depthTest:!1,depthWrite:!1,opacity:.25,transparent:!0})),this.materials.push(new MeshBasicMaterial({color:new Color(8978312),wireframe:!0,depthTest:!1,depthWrite:!1,opacity:.25,transparent:!0})),this.materials.push(new MeshBasicMaterial({color:new Color(8947967),wireframe:!0,depthTest:!1,depthWrite:!1,opacity:.25,transparent:!0})),this._init()}updateMatrixWorld(t){this.root;if(this.visible){for(var s=this.physics.pos,e=0,i=s.length;e<i;e++){(o=this.children[e]).position.copy(s[e])}for(e=0,i=this.physics.spheres.length;e<i;e++){var o=this.children[s.length+e],n=this.physics.convertCoord(this.physics.spheres[e].center,this.physics.spheres[e].handle);o.position.copy(n)}for(e=0,i=this.physics.cylinders.length;e<i;e++){o=this.children[s.length+this.physics.spheres.length+e],n=this.physics.convertCoord(this.physics.cylinders[e].upcenter,this.physics.cylinders[e].handle1);var r=this.physics.convertCoord(this.physics.cylinders[e].downcenter,this.physics.cylinders[e].handle1);o.position.copy(n.clone().add(r).multiplyScalar(.5)),o.quaternion.setFromUnitVectors(new Vector3(0,1,0),n.sub(r).normalize())}}super.updateMatrixWorld(t)}_init(){var t=this.physics.pos;function s(t){switch(t.shapeType){case 0:return new SphereGeometry(t.width,16,8);case 1:return new BoxGeometry(2*t.width,2*t.height,2*t.depth,8,8,8);case 2:return new e(t.width,t.height,16,8);default:return null}}function e(t,s,e,i){var o=new CylinderGeometry(t,t,s,e,i,!0),n=new Mesh(new SphereGeometry(t,e,i,0,2*Math.PI,0,Math.PI/2)),r=new Mesh(new SphereGeometry(t,e,i,0,2*Math.PI,Math.PI/2,Math.PI/2));return n.position.set(0,s/2,0),r.position.set(0,-s/2,0),n.updateMatrix(),r.updateMatrix(),o.merge(n.geometry,n.matrix),o.merge(r.geometry,r.matrix),o}for(var i=0,o=t.length;i<o;i++){t[i].params;this.add(new Mesh(s({shapeType:0,width:.002}),this.materials[0]))}for(i=0,o=this.physics.spheres.length;i<o;i++)this.add(new Mesh(s({shapeType:0,width:this.physics.spheres[i].radius}),this.materials[0]));for(i=0,o=this.physics.cylinders.length;i<o;i++){var n=this.physics.cylinders[i];this.add(new Mesh(s({shapeType:2,width:n.Radius,height:n.upcenter.clone().sub(n.downcenter).length()}),this.materials[0]))}}}function parseBoolean(t){return"true"===t}class ClothPhysicManager{constructor(){this.clothPhysics={}}setClothPhysics(t,s){var e=t.getObjectByName("body");null!=e&&e instanceof Mesh||(e=t.getObjectByName("head_part")),t.traverse((s=>{if(null!=s.userData&&null!=s.userData.dynamic){var i=!1;s.traverse((o=>{if(o instanceof Mesh){if(!i){var n=new ClothPhysics(o,e,s.userData.dynamic);n.resetPos=!0,null==this.clothPhysics[t]&&(this.clothPhysics[t]=[]),this.clothPhysics[t].push(n)}i=!0}}))}}))}removeClothPhysics(t){this.clothPhysics[t]=void 0}removeAllClothPhysics(){this.clothPhysics={}}update(t=.016){for(var s in this.clothPhysics){const i=this.clothPhysics[s];if(null!=i)for(var e=0;e<i.length;e++)i[e].update(t)}}}const ClothPhysicManagerInstance=new ClothPhysicManager;class ClothPhysics{constructor(t,s,e){const i=t.skeleton.bones.length;this.initPosition=new Array(i),this.originPosition=new Array(i),this.gravity=new Vector3(0,-9.8,0),this.pos=new Array(i),this.old_pos=new Array(i),this.direction=new Array(i),this.invmass=new Array(i),this.accel=new Array(i),this.upcloth=new Array(i),this.velo=new Array(i),this.shapeForce=new Array(i),this.boneHandle=this.create2dArray(11,30,-1),this.boneCol=new Array(11),this.mapBone={},this.rownum=0,this.rownum2=0,this.mapRow={},this.mapCol={},this.mapCons={},this.yMap={},this.constraints=[],this.mainBody=s,this.mesh=t,this.rowprop=.5,this.spheres=[],this.cylinders=[],this.sphereHelpers=[],this.iter=1,this.targetPosition=new Array(this.pos.length).fill(new Vector3),this.originFrameRotation={},this.originRotation={},this.resultFrameRotation={},this.sDynamicEnable=!0;const o=new Vector3;for(var n=0;n<i;n++){const s=t.skeleton.bones[n];s.index=n,s.getWorldPosition(o),this.initPosition[n]=o.clone(),this.originPosition[n]=o.clone(),this.originRotation[n]=new Quaternion,s.getWorldQuaternion(this.originRotation[n]),this.pos[n]=o.clone(),this.old_pos[n]=o.clone(),this.invmass[n]=0,this.accel[n]=new Vector3(0,0,0),this.shapeForce[n]=.5,this.upcloth[n]=!1,this.velo[n]=new Vector3(0,0,0)}this.boneCol.fill(0),this.joints={};for(n=0;n<s.skeleton.bones.length;n++)this.joints[s.skeleton.bones[n].name]=new Vector3,s.skeleton.bones[n].getWorldPosition(this.joints[s.skeleton.bones[n].name]);var r=(new DOMParser).parseFromString(e,"application/xml");const a=r.getElementsByTagName("dynamic")[0];this.constrainBoneName="head",a.hasAttribute("constrain")&&(this.constrainBoneName=a.getAttribute("constrain"),this.constrainBoneIndex=this.getBoneIndexByName(this.mainBody.skeleton,this.constrainBoneName)),this.rowcol=!0,a.hasAttribute("rowcol")&&(this.rowcol=this.parseBoolean(a.getAttribute("rowcol")));for(var h=0;h<t.skeleton.bones.length;h++){const s=t.skeleton.bones[h];var l=this.strimBoneName(s.name);const e=h;if(this.mapBone[l]=e,!this.rowcol)continue;const i=l.split("_");if(2==i.length){const t=this.strToInt(i[0],!0),s=this.strToInt(i[1],!1);if(-1==t)continue;this.boneHandle[t][s]=e,this.mapRow[e]=t,this.mapCol[e]=s,this.mapRow[e]>this.rownum&&(this.rownum=this.mapRow[e]),this.mapCol[e]>=this.boneCol[t]&&(this.boneCol[t]=this.mapCol[e]+1)}}const c=r.getElementsByTagName("particles")[0];for(var p=0;p<c.childNodes.length;p++){var u=c.childNodes[p];if(u.nodeType==Node.TEXT_NODE)continue;const t=u.getAttribute("name"),s=this.mapBone[t];var d=0;u.hasAttribute("mass")&&(d=parseFloat(u.getAttribute("mass")))>0&&(d=1/d),this.invmass[s]=d,u.hasAttribute("shapeForce")&&(this.shapeForce[s]=parseFloat(u.getAttribute("shapeForce")));var m=u.getAttribute("constrain");null==m&&(m=""),this.mapCons[s]=""!=m?m:this.constrainBoneName;const e=u.getAttribute("rightParticle");""!=e&&(null==this.mapBone[e]?this.yMap[s]=void 0:this.yMap[s]=parseInt(this.mapBone[e]))}var y=r.getElementsByTagName("upcloth");if(y.length>0){y=y[0];for(p=0;p<y.childNodes.length;p++){var g=y.childNodes[p];if(g.nodeType==Node.TEXT_NODE)continue;const t=g.getAttribute("name"),s=this.mapBone[t];if(null==s)continue;const e=g.getAttribute("constrain");""!=e&&(this.mapCons[s]=e),"hips2"==e&&(this.mapCons[s]="hips1"),this.shapeForce[s]=1,this.upcloth[s]=!0}}for(var b in this.mapConsIndex={},this.mapCons)this.mapConsIndex[b]=this.getBoneIndexByName(this.mainBody.skeleton,this.mapCons[b]);const v=r.getElementsByTagName("links")[0];if(v.getAttribute("parentchild")&&this._buildParentChildLink(t.skeleton.bones[0]),v.hasAttribute("gravity")&&(this.g=new Vector3(0,parseFloat(v.getAttribute("gravity")),0)),v.hasAttribute("constrain_iters")&&(this.max_constrain_iters=parseInt(v.getAttribute("constrain_iters"))),v.hasAttribute("kdrag")&&(this.kdrag=parseFloat(v.getAttribute("kdrag"))),v.hasAttribute("vdrag")&&(this.vdrag=parseFloat(v.getAttribute("vdrag"))),v.hasAttribute("vdrag_up")&&(this.vdrag_up=parseFloat(v.getAttribute("vdrag_up"))),v.hasAttribute("target")&&(this.TARGETCONSTRAINT=parseBoolean(v.getAttribute("target"))),v.hasAttribute("horizon")&&(this.HORIZON=parseBoolean(v.getAttribute("horizon"))),v.hasAttribute("targetprop")&&(this.targetprop=parseFloat(v.getAttribute("targetprop"))),v.hasAttribute("rowprop")&&(this.rowprop=parseFloat(v.getAttribute("rowprop"))),v.hasAttribute("earth")&&(this.EARTHCOLLISION=parseBoolean(v.getAttribute("earth"))),v.hasAttribute("jack")&&(this.JACKCLOTH=parseBoolean(v.getAttribute("jack"))),v.hasAttribute("middle")&&(this.MIDDLEPROCESS=parseBoolean(v.getAttribute("middle"))),v.hasAttribute("mulpieces")&&(this.MULPIECES=parseBoolean(v.getAttribute("mulpieces"))),v.hasAttribute("multarget")&&(this.MULTARGET=parseBoolean(v.getAttribute("multarget"))),v.hasAttribute("bodyadjust")&&(this.BODYADJUST=parseBoolean(v.getAttribute("bodyadjust"))),v.hasAttribute("collisionnew")&&(this.SQUARECOLLISION=parseBoolean(v.getAttribute("collisionnew"))),v.hasAttribute("split")&&(this.SPLITCLOTH=parseBoolean(v.getAttribute("split"))),parseBoolean(v.getAttribute("brother"))){for(var b in this.yMap)null!=this.mapRow[b]?this.AddLink(parseInt(b),this.yMap[b],-1):this.AddLink(parseInt(b),this.yMap[b],-2);for(var b in this.yMap){const t=this.yMap[this.yMap[b]];b!=t&&this.AddLink(parseInt(b),t,0)}}v.hasAttribute("rownum")&&(this.rownum=parseInt(v.getAttribute("rownum"))),v.hasAttribute("rownum2")&&(this.rownum2=parseInt(v.getAttribute("rownum2")));for(p=0;p<v.childNodes.length;p++){const t=v.childNodes[p];if(t.nodeType==Node.TEXT_NODE)continue;var f=1;const s=t.getAttribute("start"),e=t.getAttribute("end");t.hasAttribute("soft")&&(f=parseFloat(t.getAttribute("soft")),f=-1),this.AddLink(this.mapBone[s],this.mapBone[e],f)}for(var b in this.addSolids(a),this.squareListInit(),this.calcBoneTransform(),this.resultFrameRotation)this.originFrameRotation[b]=this.resultFrameRotation[b].clone();this.pp=0}calcBoneTransform(){const t=this.mesh.skeleton.bones.length,s=this.mesh.skeleton.bones;for(var e=0;e<t;e++){var i=s[e],o=(i.parent,i.children[0]);if(0==this.upcloth[e]){if(i==s[0]){this.resultFrameRotation[e]=i.getWorldQuaternion(new Quaternion);continue}var n=this.pos[e].clone().sub(this.pos[i.parent.index]);null!=o&&(this.mapRow[e]>2?n.add(this.pos[o.index].clone().sub(this.pos[e])):2==this.mapRow[e]&&(n=this.pos[o.index].clone().sub(this.pos[e])));const t=this.yMap[this.mapBone[this.strimBoneName(i.name)]];var r=new Vector3(0,0,-1);null!=t&&r.copy(this.pos[t].clone().sub(this.pos[e]));var a=n.clone();a.cross(r),r.copy(a).cross(n),n.normalize(),r.normalize(),a.normalize();var h=new Matrix4;h.makeBasis(n,r,a);var l=new Quaternion;l.setFromRotationMatrix(h),this.resultFrameRotation[e]=l}}}updateBone(){const t=this.mesh.skeleton.bones.length,s=this.mesh.skeleton.bones;this.calcBoneTransform();for(var e=0;e<t;e++){if(this.upcloth[e]||0==e||0==this.invmass[e])continue;const t=s[e];var i=this.pos[e].clone(),o=this.resultFrameRotation[e],n=this.originFrameRotation[e],r=this.originRotation[e],a=(o.clone().multiply(n.clone().invert()),o.clone().multiply(n.clone().invert()).multiply(r));if(t.parent){t.parent.updateWorldMatrix(!0,!1),t.parent.worldToLocal(i),t.position.set(i.x,i.y,i.z);const s=t.parent.getWorldQuaternion(new Quaternion).invert();s.multiply(a),t.quaternion.set(s.x,s.y,s.z,s.w),t.updateWorldMatrix(!0,!1)}}}strimBoneName(t){const s=t.split("_");return 3==s.length&&(t.includes("one")||t.includes("two")||t.includes("three")||t.includes("four")||t.includes("five")||t.includes("six")||t.includes("seven")||t.includes("eight")||t.includes("zero"))&&(t=s[0]+"_"+s[1]),t}squareListInit(){if("head"!=this.constrainBoneName){this.squareList=new Array(2).fill();for(var t=0;t<this.squareList.length;t++)this.squareList[t]=[];if(0==this.rownum2)for(t=0;t<this.squareList.length;t++)this.squareList[t].push(t);else for(t=0;t<this.squareList.length;t++)this.squareList[t].push(t),this.squareList[t].push(t+2)}}loadSolid(t,s,e,i,o){t.hasAttribute("start_bias_x")&&(s.x=parseFloat(t.getAttribute("start_bias_x"))/100),t.hasAttribute("start_bias_y")&&(s.y=parseFloat(t.getAttribute("start_bias_y"))/100),t.hasAttribute("start_bias_z")&&(s.z=parseFloat(t.getAttribute("start_bias_z"))/100),t.hasAttribute("end_bias_x")&&(e.x=parseFloat(t.getAttribute("end_bias_x"))/100),t.hasAttribute("end_bias_y")&&(e.y=parseFloat(t.getAttribute("end_bias_y"))/100),t.hasAttribute("end_bias_z")&&(e.z=parseFloat(t.getAttribute("end_bias_z"))/100),t.hasAttribute("radius")&&(o.radius=parseFloat(t.getAttribute("radius"))/200),t.hasAttribute("start_bone")&&(o.s=t.getAttribute("start_bone")),t.hasAttribute("end_bone")&&(o.e=t.getAttribute("end_bone"))}addSolids(t){var s=t.getElementsByTagName("solids");if(null!=s&&(s=s[0],null!=this.mainBody)){var e=this.mainBody.skeleton,i=new Vector3(0,-.02,-.03),o=!1,n=!1,r="Leftchest1",a="rightchest1",h=!!this.BODYADJUST,l=t.getElementsByTagName("spheres")[0];if(this.spheres=[],null!=l)for(var c=0;c<l.childNodes.length;c++){const t=l.childNodes[c];if(t.nodeType!=Node.TEXT_NODE){var p=new Vector3,u=new Vector3,d=.08,m={};this.loadSolid(t,p,u,d,m);var y=this.getBoneIndexByName(e,m.s);(B=this.calcJointPos(m.s,h)).add(p);var g={center:B,radius:m.radius,handle:y,name:m.s,isAuto:!1};this.spheres.push(g)}}var b=t.getElementsByTagName("cylinders");if(null!=b){b=b[0],this.cylinders=[];for(c=0;c<b.childNodes.length;c++){const t=b.childNodes[c];if(t.nodeType!=Node.TEXT_NODE){p=new Vector3,u=new Vector3,d=.08,m={};this.loadSolid(t,p,u,d,m),m.s==r?o=!0:m.s==a&&(n=!0);var v=this.calcJointPos(m.s,h),f=this.calcJointPos(m.e,h);y=this.getBoneIndexByName(e,m.s);v.add(p);var w=this.getBoneIndexByName(e,m.e);f.add(u);var A=(C=f.clone().sub(v)).length();C.normalize(),this.cylinders.push({upcenter:v,downcenter:f,Radius:m.radius,Length:A,handle1:y,handle2:w,name:m.s,downname:m.e,isAuto:o||n})}}if("head"==this.constrainBoneName){if(!o){y=this.getBoneIndexByName(this.mainBody.skeleton,r);(B=this.calcJointPos(r,h)).add(i);w=this.getBoneIndexByName(this.mainBody.skeleton,"Leftchest");(f=this.calcJointPos("Leftchest",h)).add(i);A=(C=f.clone().sub(B)).length();C.normalize(),this.cylinders.push({upcenter:B,downcenter:f,Radius:.04,Length:A,handle1:y,handle2:w,name:r,downname:"Leftchest",isAuto:!0})}if(!n){var B;y=this.getBoneIndexByName(this.mainBody.skeleton,a);(B=this.calcJointPos(a,h)).add(i);w=this.getBoneIndexByName(this.mainBody.skeleton,"rightchest");(f=this.calcJointPos("rightchest",h)).add(i);var C;A=(C=f.clone().sub(B)).length();C.normalize(),this.cylinders.push({upcenter:B,downcenter:f,Radius:.04,Length:A,handle1:y,handle2:w,name:a,downname:"rightchest",isAuto:!0})}}for(var P=0;P<this.cylinders.length;P++)this.cylinders[P].up_old=this.cylinders[P].upcenter.clone(),this.cylinders[P].down_old=this.cylinders[P].downcenter.clone()}}}createHelper(){return new ClothHelper(this.mesh,this)}initParticlePosition(){}_buildParentChildLink(t){for(var s=0;s<t.children.length;s++){const e=t.children[s];null!=e&&(console.log(t.name+" "+e.name),this.AddLink(this.mapBone[this.strimBoneName(t.name)],this.mapBone[this.strimBoneName(e.name)],1),this._buildParentChildLink(e))}}getBoneIndexByName(t,s){for(var e=t.bones,i=-1,o=0;o<e.length;o++)if(e[o].name==s){i=o;break}return i}AddLink(t,s,e){if(-1==t||-1==s)return;if(null==t||null==s)return;if(1==this.upcloth[t]&&1==this.upcloth[s])return;const i={};i.particleA=t,i.particleB=s,i.soft=e,i.restLength=(new Vector3).copy(this.pos[t]).sub(this.pos[s]).length(),this.constraints.push(i)}strToInt(t,s){if(s){const s=["zero","one","two","three","four","five","six","seven","eight","nine","ten"];for(var e=0;e<s.length;e++)if(s[e]==t)return e;return-1}return parseInt(t)}create2dArray(t,s,e){for(var i=new Array(t),o=0;o<i.length;o++)i[o]=new Array(s).fill(e);return i}convertCoord(t,s){const e=this.mainBody.skeleton.bones[s],i=this.mainBody.skeleton.boneInverses[s],o=new Matrix4;if(null==e)return t;e.updateWorldMatrix(!0,!1),o.multiplyMatrices(e.matrixWorld,i);var n=t.clone();return n.applyMatrix4(o),n}update(t){const s=new Array(this.cylinders.length),e=new Array(this.cylinders.length),i=new Array(this.spheres.length),o=this.cylinders.length;for(var n=0;n<o;n++)s[n]=this.convertCoord(this.cylinders[n].upcenter,this.cylinders[n].handle1),e[n]=this.convertCoord(this.cylinders[n].downcenter,this.cylinders[n].handle1);const r=this.spheres.length;for(n=0;n<r;n++)i[n]=this.convertCoord(this.spheres[n].center,this.spheres[n].handle);if(this.resetPos){for(var a=0,h=0;h<this.pos.length;h++)this.JACKCLOTH&&!this.upcloth[h]?this.targetPosition[h]=this.convertCoord(this.initPosition[h],this.constrainBoneIndex):this.targetPosition[h]=this.convertCoord(this.initPosition[h],this.mapConsIndex[h]),(0==this.invmass[h]||this.upcloth[h])&&(this.targetPosition[h].clone().sub(this.old_pos[h]).length(),a++);a;for(var h=0;h<this.pos.length;h++)this.old_pos[h].copy(this.targetPosition[h]),this.pos[h].copy(this.targetPosition[h]),this.velo[h].set(0,0,0);return void(this.resetPos=!1)}for(h=0;h<this.pos.length;h++)this.JACKCLOTH&&!this.upcloth[h]?this.targetPosition[h]=this.convertCoord(this.initPosition[h],this.constrainBoneIndex):this.targetPosition[h]=this.convertCoord(this.initPosition[h],this.mapConsIndex[h]),(0==this.invmass[h]||this.upcloth[h])&&(this.old_pos[h].copy(this.pos[h]),this.pos[h].copy(this.targetPosition[h]));0!=this.cylinders.length&&this.clothFixMove(this.cylinders[0].Radius);const l=2/(1+Math.exp(-this.kdrag))-1;for(n=0;n<this.pos.length;n++)0==this.invmass[n]||this.upcloth[n]||(this.old_pos[n].copy(this.pos[n]),this.pos[n].add((new Vector3).copy(this.velo[n]).multiplyScalar(1-l).add((new Vector3).copy(this.gravity).multiplyScalar(t*t)).add((new Vector3).copy(this.accel[n]).multiplyScalar(t*t))),this.accel[n].multiplyScalar(.8));if(this.JACKCLOTH&&this.BODYADJUST){var c=new Array(this.pos.length);this.copyVector3Array(c,this.pos),this.copyVector3Array(this.pos,this.targetPosition),this.springRestlengthReset(this.targetPosition),this.solveCollisionSquare(s,e),this.springConstrain(this.targetPosition),this.copyVector3Array(this.targetPosition,this.pos),this.copyVector3Array(this.pos,c),this.springRestlengthReset(this.targetPosition)}if(this.SQUARECOLLISION&&this.secondRowAdjust(this.targetPosition),0!=this.cylinders.length)for(n=0;n<2;n++)this.springConstrain(this.targetPosition);else this.constrain();for(var p=0;p<this.iter;p++)for(h=0;h<this.pos.length;h++)if(0==this.invmass[h]||this.upcloth[h])this.pos[h].copy(this.targetPosition[h]);else{var u=this.shapeForce[h];0==this.sDynamicEnable?u=1:this.confirm&&(u=1+(this.shapeForce[h]-1)*(this.frameCount-1)/10),this.pos[h]=this.pos[h].multiplyScalar(1-u).add(this.targetPosition[h].clone().multiplyScalar(u))}this.SQUARECOLLISION&&!this.SPLITCLOTH&&this.maxParticleDistance(this.targetPosition);for(n=0;n<this.pos.length;n++)this.velo[n].copy(this.pos[n]).sub(this.old_pos[n]);return 0!=this.cylinders.length&&this.sDynamicEnable&&(this.SQUARECOLLISION&&(this.stabilityConstrain(this.targetPosition),this.solveCollisionSquare(s,e)),this.solveCollision(s,e,i,this.HORIZON)),this.updateBone(),this}copyVector3Array(t,s){for(var e=0;e<s.length;e++)null==t[e]?t[e]=s[e].clone():t[e].copy(s[e])}clothFixMove(t){for(var s=0;s<this.boneCol[2];s++)if(-1!=this.boneHandle[2][s]){var e=this.pos[this.boneHandle[2][s]].clone().sub(this.old_pos[this.boneHandle[2][s]]),i=.5*t,o=e.clone(),n=o.length();o.normalize();for(var r=0==this.rownum2?this.rownum:this.rownum2,a=0;a<=r;a++)-1!=this.boneHandle[a][s]&&0!=this.invmass[this.boneHandle[a][s]]&&n>i&&this.pos[this.boneHandle[a][s]].add(e.clone().sub(o.clone().multiplyScalar(i)))}}springRestlengthReset(t){for(var s=0;s<this.constraints.length;s++){var e=this.constraints[s].particleA,i=this.constraints[s].particleB;this.upcloth[e]||this.upcloth[i]||(this.invmass[e]||this.invmass[i])&&(this.constraints[s].restLength=t[e].clone().sub(t[i]).length())}}secondRowAdjust(t){if(this.rownum<2)return;if("hips1"!=this.constrainBoneName)return;for(var s=0;s<this.boneCol[2];s++){for(var e=0==this.rownum2?this.rownum:this.rownum-1,i=this.boneHandle[2][s];e>2&&-1==this.boneHandle[e][s];)e--;if(2!=e){var o=this.boneHandle[e][s],n=this.boneHandle[3][s],r=this.initPosition[i].clone().sub(this.initPosition[o]),a=r.length();r.normalize();var h=t[i].clone().sub(t[o]),l=t[n].clone().sub(t[o]);l.normalize();for(var c=h.dot(l),p=3;p<e;p++){if(-1!=(b=this.boneHandle[p][s])){var u=this.initPosition[b].clone().sub(this.initPosition[o]).dot(r);u/=a,t[b].copy(l.clone().multiplyScalar(u*c).add(t[o]))}}}}var d=this.GetBonePos(this.constrainBoneName),m=this.calcJointPos(this.constrainBoneName).sub(new Vector3(0,1,0)),y=this.convertCoord(m,this.constrainBoneIndex).sub(d);y.normalize();for(p=0;p<this.boneCol[2];p++){var g=this.boneHandle[3][p];if(-1!=g){var b,v=t[b=this.boneHandle[2][p]].clone().sub(d);v.normalize();var f=y.clone().cross(v);f.normalize();var w=t[g].clone().sub(d);(w=w.clone().sub(f.clone().multiplyScalar(w.dot(f)))).normalize();var A=y.dot(v);y.dot(w)<A&&(t[b]=w.clone().multiplyScalar(t[b].clone().sub(d).dot(w)).add(d))}}}solveCollision(t,s,e,i){for(var o,n,r,a=[],h=new Array(this.pos.length),l=0;l<h.length;l++)h[l]=new Vector3;var c="head"!=this.constrainBoneName;for(l=0;l<this.cylinders.length;l++){var p=t[l].clone().sub(s[l]);p.normalize(),a.push(p)}for(var u=0;u<this.constraints.length;u++){var d=this.constraints[u].particleA,m=this.constraints[u].particleB;if((-1==this.constraints[u].soft||1==this.constraints[u].soft)&&((!i||-1==this.constraints[u].soft)&&!this.upcloth[d]&&!this.upcloth[m]&&(c||0!=this.invmass[d])&&0!=this.invmass[m])){o=this.pos[d].clone();(r=(n=this.pos[m].clone()).clone().sub(o).clone()).length();r.normalize();var y=c?1:this.invmass[d],g=c?1:this.invmass[m];for(l=0;l<this.cylinders.length;l++)this.move_segment_outside_cylinder(this.pos[d],this.pos[m],a[l],t[l],s[l],this.cylinders[l].Radius,y,g);for(l=0;l<this.spheres.length;l++)this.move_segment_outside_sphere(this.pos[d],this.pos[m],y,g,e[l],this.spheres[l].radius);h[d].add(this.pos[d]).sub(o),h[m].add(this.pos[m]).sub(n)}}if(this.EARTHCOLLISION&&this._isUseEarth)for(l=0;l<this.pos.length;l++)(this.upcloth[l]||0==this.invmass[l])&&W;for(var b=0;b<h.length;b++)if(0!=h[b].length()){var v=h[b].clone();v.normalize();var f=v.clone().multiplyScalar(this.velo[b].dot(v)),w=this.velo[b].clone().sub(f);this.velo[b]=v.clone().multiplyScalar(.4*f.length()).add(w.multiplyScalar(.8))}}stabilityConstrain(t){if(0==this.cylinders.length)return;var s=this.calcJointPos(this.constrainBoneName).clone().add(new Vector3(0,1,0));if((s=this.convertCoord(s,this.constrainBoneIndex).sub(this.GetBonePos(this.constrainBoneName))).y<0)return;const e=0==this.rownum2?this.rownum:this.rownum-1;this.cylinders[0].Radius;for(var i=0;i<this.cylinders.length;i++)if("rightUpLeg"==this.cylinders[i].name||"leftUpLeg"==this.cylinders[i].name){2*this.cylinders[i].Radius;break}const o=new Array(2),n=new Array(2);o[0]=this.GetBonePos("rightUpLeg"),o[1]=this.GetBonePos("leftUpLeg"),n[0]=o[0].clone().sub(this.GetBonePos("rightLeg")),n[1]=o[1].clone().sub(this.GetBonePos("leftLeg"));for(var r=0;r<2;r++)if(!(n[r].y>0)){n[r].normalize();for(i=2;i<e;i++)for(var a=0;a<this.boneCol[i];a++){var h=this.boneHandle[i][a];if(-1==h||0==this.invmass[h]||t[h].clone().sub(o[r]).dot(n[r])>0)continue;const s=this.pos[h].clone().sub(o[r]);s.clone().sub(n[r].clone().multiplyScalar(s.dot(n[r]))).y>0&&s.dot(n[r])>0&&this.pos[h].sub(n[r].clone().multiplyScalar(s.dot(n[r])))}}}CONSTRAIN_FIX_MOVE(t,s,e){s.copy((new Vector3).copy(t).add((new Vector3).copy(s).sub(t).normalize().multiplyScalar(e)))}GetBonePos(t){var s=new Vector3;return this.mainBody.skeleton.getBoneByName(t).getWorldPosition(s),s}calcJointPos(t){return this.joints[t].clone()}maxParticleDistance(t){if(0==this.cylinders.length)return;this.rownum2,this.rownum;const s=this.GetBonePos(this.constrainBoneName);var e=this.calcJointPos(this.constrainBoneName).clone().add(new Vector3(0,1,0));if(!((e=this.convertCoord(e,this.constrainBoneIndex)).y<s.y-.2)){for(var i=2*this.cylinders[0].Radius,o=0;o<this.cylinders.length;o++)if("rightUpLeg"==this.cylinders[o].name||"leftUpLeg"==this.cylinders[o].name){i=2*this.cylinders[o].Radius;break}for(o=2;o<this.rowall;o++){const s=i*(o-2)/(this.rowall-2);for(var n=0;n<this.boneCol[o];n++){const e=this.boneHandle[o][n];if(-1==e||0==this.invmass[e])continue;const a=this.pos[e].clone().sub(t[e]).length();if(a>s){var r=a-s;r>i&&(r=i),this.pos[e].add(t[e].clone().sub(this.pos[e]).multiplyScalar(r/a))}}}}}solveCollisionSquare(t,s){const e=this.squareList.length;for(var i,o,n,r,a=!1,h=[],l=new Array(this.pos.length),c=0;c<l.length;c++)l[c]=new Vector3;var p,u,d=[],m=new Quaternion,y=new Quaternion,g=new Array(this.pos.length);for(c=0;c<this.pos.length;c++)g[c]=this.pos[c].clone();for(c=0;c<e;c++){d=[],h=[];for(var b=0;b<this.squareList[c].length;b++){const e=this.squareList[c][b];var v=t[e].clone().sub(s[e]);d.push(v.length()),v.normalize(),h.push(v)}if(2==this.squareList[c].length)a=!0;else{if(1!=this.squareList[c].length)continue;a=!1}var f,w,A,B=this.squareList[c][0];a?(A=this.squareList[c][1],u=this.cylinders[B].Radius,f=h[0].clone(),w=h[1].clone().multiplyScalar(-1),r=s[B].clone(),m.setFromUnitVectors(w.clone().multiplyScalar(-1),f),n=s[A].clone().sub(s[B]).applyQuaternion(m).add(s[B])):u=this.cylinders[B].Radius,i=t[B].clone(),o=s[B].clone(),p=this.cylinders[B].Radius;const e={};for(b=0;b<this.boneCol[2];b++){var C=this.boneHandle[2][b];-1!=C&&(e[C]=this.convertCoord(this.initPosition[C],this.cylinders[this.squareList[c][0]].handle1))}const E=new Array(this.pos.length).fill(!1);for(var P=0;P<this.constraints.length;P++){if(-1!=this.constraints[P].soft)continue;const h=this.constraints[P];var S=h.particleA,L=h.particleB,_=this.mapRow[S],T=this.mapCol[S],N=this.mapRow[L],I=this.mapCol[L],x=this.boneHandle[N-1][I],M=this.boneHandle[_-1][T];if(-1==this.boneHandle[_][T]||-1==this.boneHandle[N][I]||0==this.invmass[this.boneHandle[_][T]]||0==this.invmass[this.boneHandle[N][I]])continue;const c=new Array(4);new Array(4),new Array(4);c[0]=this.pos[this.boneHandle[_-1][I]].clone(),c[1]=this.pos[this.boneHandle[_-1][T]].clone(),this.SPLITCLOTH||(x=this.boneHandle[2][I],M=this.boneHandle[2][T],c[0].copy(e[x]),c[1].copy(e[M])),3==_&&(c[0].copy(e[x]),c[1].copy(e[M])),c[2]=this.pos[S].clone(),c[3]=this.pos[L].clone(),i=t[B].clone(),o=s[B].clone();var R=!1,V=new Array(2);if(V[0]=c[0].clone(),V[1]=c[1].clone(),a&&this.mapRow[S]>=this.rownum){const s=c[2].clone().sub(r),e=c[3].clone().sub(r),a=c[0].clone().sub(r),h=c[1].clone().sub(r);a.dot(f),h.dot(f),a.dot(w),h.dot(w);(E[x]||E[M])&&(c[0].copy(a.clone().applyQuaternion(m).add(r)),c[1].copy(h.clone().applyQuaternion(m).add(r))),s.dot(f)<s.dot(w)||e.dot(f)<e.dot(w)?(i=t[A].clone(),o=n.clone(),c[2].copy(s.clone().applyQuaternion(m).add(r)),c[3].copy(e.clone().applyQuaternion(m).add(r)),R=R||this.pushVerticlesOutside(c,i,o,!0,u),c[2].copy(c[2].clone().sub(r).applyQuaternion(y.copy(m).invert()).add(r)),c[3].copy(c[3].clone().sub(r).applyQuaternion(y.copy(m).invert()).add(r)),E[S]=E[L]=!0):R=this.pushVerticlesOutside(c,i,o,!1,p)}else R=this.pushVerticlesOutside(c,i,o,!1,p,P);x=this.boneHandle[N-1][I],M=this.boneHandle[_-1][T],V[0].copy(g[x]),V[1].copy(g[M]);var O=g[S].clone().sub(g[M]).length(),H=c[2].clone().sub(this.pos[M]).length();0!=H&&c[2].copy(c[2].clone().sub(this.pos[M]).multiplyScalar(O/H).add(this.pos[M])),O=g[L].clone().sub(g[x]).length(),0!=(H=c[3].clone().sub(this.pos[x]).length())&&c[3].copy(c[3].clone().sub(this.pos[x]).multiplyScalar(O/H).add(this.pos[x])),R&&(l[S].add(c[2]).clone().sub(this.pos[S]),l[L].add(c[3]).clone().sub(this.pos[L])),this.pos[S].copy(c[2]),this.pos[L].copy(c[3])}}for(var E=0;E<l.length;E++){if(l[E].length()<1e-5)continue;const t=l[E].clone();t.normalize();const s=t.multiplyScalar(this.velo[E].dot(t)),e=this.velo[E].clone().sub(s);this.velo[E]=t.multiplyScalar(.4*s.length()).add(e.multiplyScalar(.8))}}pushVerticlesOutside(t,s,e,i,o,n){var r=0,a=s.clone().sub(e);const h=new Array(4),l=new Array(4);for(a.normalize(),r=0;r<t.length;r++){if((i?t[r].clone().sub(e):s.clone().sub(t[r])).dot(a)>=0)break}if(r==t.length)return!1;l[3]=t[3].clone();for(var c=a.clone().multiplyScalar(l[3].clone().sub(s).dot(a)).add(s),p=0;p<t.length-1;p++)l[p]=a.clone().multiplyScalar(l[3].clone().sub(t[p]).dot(a)).add(t[p]);h[0]=l[0].clone().sub(c).cross(l[t.length-1].clone().sub(c));for(p=1;p<t.length;p++)h[p]=l[p].clone().sub(c).cross(l[p-1].clone().sub(c));var u=!1;for(p=1;p<h.length;p++)if(h[p].dot(h[0])<0){u=!0;break}var d=l[2].clone().sub(l[3]);d.normalize();var m=c.clone().sub(l[3]).dot(d)/l[2].clone().sub(l[3]).length();m=clamp(m,0,1);var y=l[3].clone().add(l[2].clone().sub(l[3]).multiplyScalar(m)).clone().sub(c),g=y.length();if(y.normalize(),u){if(!(g<o))return!1;y=y.clone().multiplyScalar(o-g)}else y=y.clone().multiplyScalar(-1).multiplyScalar(g+o);var b=t[2].clone().sub(t[1]).length(),v=t[3].clone().sub(t[0]).length();if(t[2].add(y),t[3].add(y),!this.SPLITCLOTH){var f=t[2].clone().sub(t[1]),w=t[3].clone().sub(t[0]);b-=f.length(),v-=w.length(),t[2].add(a.clone().multiplyScalar(-b)),t[3].add(a.clone().multiplyScalar(-v))}return!0}constrain(){const t=new Array(this.spheres.length);new Array(this.spheres.length);for(var s=0;s<this.spheres.length;s++)t[s]=this.convertCoord(this.spheres[s].center,this.spheres[s].handle);for(var e=0;e<5;e++)for(var i=0;i<this.constraints.length;i++){const s=this.constraints[i];if((0!=this.invmass[s.particleA]||0!=this.invmass[s.particleB])&&(1==s.soft&&(this.CONSTRAIN_FIX_MOVE(this.pos[s.particleA],this.pos[s.particleB],s.restLength),0!=this.invmass[s.particleA]&&0!=this.invmass[s.particleB])))for(var o=0;o<t.length;o++)this.move_segment_outside_sphere(this.pos[s.particleA],this.pos[s.particleB],this.invmass[s.particleA],this.invmass[s.particleB],t[o],this.spheres[o].radius)}}move_segment_outside_sphere(t,s,e,i,o,n){const r=(new Vector3).copy(t).sub(o),a=(new Vector3).copy(s).sub(o);var h=(new Vector3).copy(a).sub(r),l=-r.dot(h)/h.lengthSq();l=clamp(l,0,1);const c=(new Vector3).copy(r).add(h.clone().multiplyScalar(l));if(c.length()<n){var p=c.clone();p.normalize();const o=p.multiplyScalar(n).sub(c);0!=e&&t.add(o),0!=i&&s.add(o)}}move_segment_outside_cylinder(t,s,e,i,o,n,r,a){const h=s.clone().sub(t),l=e.clone().multiplyScalar(h.dot(e)).add(t),c=e.clone().multiplyScalar(s.clone().sub(i).dot(e)).add(i),p=s.clone().sub(l),u=p.length();p.normalize();var d=c.clone().sub(l).dot(p)/u;d=clamp(d,0,1);var m=s.clone().sub(l).multiplyScalar(d).sub(c).add(l);const y=h.clone().multiplyScalar(d).add(t);if(y.clone().sub(i).dot(e)*y.clone().sub(o).dot(e)>0){const s=i.clone();y.clone().sub(o).dot(e)<0&&s.copy(o),d=s.clone().sub(t).dot(h)/h.lengthSq(),d=clamp(d,0,1),m=h.clone().multiplyScalar(d).sub(s).add(t)}if(m.length()<n){var g=m.length();m.normalize();var b=m.clone().multiplyScalar(n-g);0!=r&&t.add(b),0!=a&&s.add(b)}}springConstrain(t){var s,e,i,o,n,r=new Vector3,a=1;const h={},l={};if(0!=this.rownum2)for(var c=0;c<this.constraints.length;c++)if(-1==this.constraints[c].soft&&this.mapRow[this.constraints[c].particleA]==this.rownum-1){h[this.mapCol[this.constraints[c].particleA]]=this.constraints[c].restLength}else if(0==this.constraints[c].soft&&this.mapRow[this.constraints[c].particleA]==this.rownum-1){l[this.mapCol[this.constraints[c].particleA]]=this.constraints[c].restLength}for(c=0;c<this.constraints.length;c++)if(s=this.constraints[c].particleA,e=this.constraints[c].particleB,!(0==this.invmass[s]&&0==this.invmass[e]||this.upcloth[s]&&this.upcloth[e]))if(o=this.constraints[c].restLength,1==this.constraints[c].soft){const t=this.constraints[c];if(0==this.invmass[t.particleA]&&0==this.invmass[t.particleB])continue;r.copy(this.pos[t.particleB]),r.sub(this.pos[t.particleA]),n=r.length(),r.normalize(),n>t.restLength&&(this.CONSTRAIN_FIX_MOVE(this.pos[t.particleA],this.pos[t.particleB],t.restLength),0!=this.invmass[t.particleA]&&this.pos[t.particleA].add((new Vector3).copy(r).multiplyScalar(.5*(n-t.restLength))))}else if(-1==this.constraints[c].soft||-2==this.constraints[c].soft){a=this.rowprop;const n=this.mapRow[s];(this.MIDDLEPROCESS||!this.JACKCLOTH&&!this.SPLITCLOTH&&this.mapCons[s]!=this.mapCons[e])&&(o=this.constraints[c].restLength=(new Vector3).copy(t[s]).sub(t[e]).length()),r.copy(this.pos[e]).sub(this.pos[s]),i=r.length(),r.normalize(),0!=this.rownum2&&n>=this.rownum&&o<h[this.mapCol[s]]&&(o=h[this.mapCol[s]]),i-=o,0!=this.invmass[s]&&this.pos[s].add((new Vector3).copy(r).multiplyScalar(a*i/2)),0!=this.invmass[e]&&this.pos[e].sub((new Vector3).copy(r).multiplyScalar(a*i/2))}else if(0==this.constraints[c].soft){a=.1;const n=this.mapRow[s];(this.MIDDLEPROCESS||!this.JACKCLOTH&&!this.SPLITCLOTH&&this.mapCons[s]!=this.mapCons[e])&&(o=this.constraints[c].restLength=(new Vector3).copy(t[s]).sub(t[e]).length()),r.copy(this.pos[e]).sub(this.pos[s]),i=r.length(),r.normalize(),0!=this.rownum2&&n>=this.rownum&&o<l[this.mapCol[s]]&&(o=l[this.mapCol[s]]),i-=o,0!=this.invmass[s]&&this.pos[s].add((new Vector3).copy(r).multiplyScalar(a*i/2)),0!=this.invmass[e]&&this.pos[e].sub((new Vector3).copy(r).multiplyScalar(a*i/2))}}reset(){return this}warmup(t){return this}setGravity(t){return this}_init(t,s,e){}_stepSimulation(t){}_updateRigidBodies(){}_updateBones(){}}export{ClothPhysicManagerInstance};