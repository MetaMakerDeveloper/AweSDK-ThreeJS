<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Hello MetaMaker For Three</title>
  </head>

  <script src="./three/build/three.js"></script>
  <script src="./three/examples/js/controls/OrbitControls.js"></script>
  <script src="/libs/metamaker-for-three.js"></script>
  <body>
    <div id="idol" style="width: 100vw; height: 100vh"></div>
    <div style="position: absolute; left: 0px; top: 0px">
      <select name="" id="animate-select">
        <option value="anim/220515_daiji">anim/220515_daiji</option>
        <option value="anim/Stand_Idel">anim/Stand_Idel</option>
        <option value="anim/Talking_BGY_F0">anim/Talking_BGY_F0</option>
        <option value="anim/anim_220415_F34">anim/anim_220415_F34</option>
        <option value="anim/Anim_220422_F5311">anim/Anim_220422_F5311</option>
        <option value="anim/ABS_Fxiang_shuangren_16_M0">anim/ABS_Fxiang_shuangren_16_M0</option>
        <option value="anim/BaseAnim/Anim_walk_M01">anim/BaseAnim/Anim_walk_M01</option>
      </select>
      <div style="margin-top: 4px">
        <textarea placeholder="请输入文字" name="" cols="30" rows="10" id="tts"></textarea>
      </div>
    </div>
  </body>
  <style>
    body {
      margin: 0px;
      padding: 0px;
    }
  </style>

  <script>
    const CANVAS_WIDTH = 800;
    const CANVAS_HEIGHT = 600;

    const FADEIN = 0.5;
    const FADEOUT = 0.5;

    let THREE = window.THREE;
    let renderer;
    let camera;
    let scene;
    let clock;
    let mixer;
    let idol;
    let controls;
    let actions = [];
    let audios = [];
    let emos = [];
    window.onload = () => {
      clock = new THREE.Clock();
      initRenderer();
      initScreen();
      refreshSize();
      initIdol("http://img.metaworks.cn/threejs_res/12456/character.gltf");
      animate();
    };

    function initRenderer() {
      renderer = new THREE.WebGLRenderer({
        antialias: true,
        alpha: true,
      });
      renderer.outputEncoding = THREE.sRGBEncoding;
      renderer.shadowMap.type = THREE.PCFSoftShadowMap;
      renderer.shadowMap.enabled = true;
    }

    function initScreen() {
      document.querySelector("#idol").appendChild(renderer.domElement);
      camera = new THREE.PerspectiveCamera(3.8, CANVAS_WIDTH / CANVAS_HEIGHT, 3, 1000);
      camera.position.set(0, 2.1, 10);
      camera.lookAt(0, 1, 0);

      scene = new THREE.Scene();
      let directionalLight = new THREE.DirectionalLight(0xffffff);
      directionalLight.intensity = 0.2;
      directionalLight.position.set(-1.45, 1, 3.57);
      directionalLight.visible = true;
      scene.add(directionalLight);

      let spotLight = new THREE.SpotLight();
      spotLight.color = new THREE.Color("#ffffff");
      spotLight.visible = true;
      spotLight.intensity = 0.28;
      spotLight.distance = 0;
      spotLight.penumbra = 0;
      spotLight.decay = 2;
      spotLight.position.set(-3.18, 1, 2.25);
      spotLight.angle = 0.14;
      spotLight.castShadow = false;
      spotLight.target.position.set(0, 0.6, 0);
      scene.add(spotLight);
      scene.add(spotLight.target);

      spotLight = new THREE.SpotLight();
      spotLight.visible = true;
      spotLight.color = new THREE.Color("#ffffff");
      spotLight.intensity = 0.2;
      spotLight.angle = 1.4;
      spotLight.penumbra = 0;
      spotLight.castShadow = false;
      spotLight.position.set(0.77, 1.13, -1.48);
      spotLight.target.position.set(0, 0.6, 0);
      scene.add(spotLight);
      scene.add(spotLight.target);

      spotLight = new THREE.SpotLight();
      spotLight.visible = true;
      spotLight.color = new THREE.Color("#ffffff");
      spotLight.intensity = 0.34;
      spotLight.distance = 0;
      spotLight.angle = 1.4;
      spotLight.penumbra = 0;
      spotLight.decay = 2;
      spotLight.castShadow = false;
      spotLight.position.set(2.25, 1.4, 2.96);
      spotLight.target.position.set(0, 0.6, 0);
      scene.add(spotLight);
      scene.add(spotLight.target);

      let ambientLight = new THREE.AmbientLight("#fffdf0");
      ambientLight.intensity = 0.1;
      ambientLight.visible = true;
      scene.add(ambientLight);

      let hemiLight = new THREE.HemisphereLight("#ffffff", "#cccccc");
      hemiLight.intensity = 0.48;
      hemiLight.position.set(0, 0, 10);
      scene.add(hemiLight);

      controls = new THREE.OrbitControls(camera, renderer.domElement);
      controls.target.set(0, 1, 0);
      controls.enablePan = true;
      controls.enableZoom = true;
      controls.update();
    }
    async function initIdol(url) {
      idol = await _MMFT.loadModel(url);
      scene.add(idol);
      mixer = new THREE.AnimationMixer(idol);
      await handleAnimateChange("anim/220515_daiji");
    }

    async function handleAnimateChange(animateName) {
      let clip = await _MMFT.loadAnimate(animateName);
      let action = mixer.clipAction(clip);

      while (actions.length) {
        let lastAction = actions.pop();
        lastAction.fadeOut(FADEOUT);
        setTimeout(() => {
          lastAction.paused = true;
        }, FADEOUT);
      }
      actions.push(action);
      action.fadeIn(FADEIN);
      action.play();
    }

    function animate() {
      let delta = clock.getDelta();
      window.requestAnimationFrame(animate);
      mixer && mixer.update(delta);
      renderer.render(scene, camera);
    }

    function refreshSize() {
      let rect = document.querySelector("#idol").getBoundingClientRect();
      camera.aspect = rect.width / rect.height;
      camera.updateProjectionMatrix();
      renderer.setSize(rect.width, rect.height);
    }

    document.querySelector("#animate-select").addEventListener("change", (e) => {
      handleAnimateChange(e.target.value);
    });

    document.querySelector("#tts").addEventListener("keyup", (e) => {
      if (e.keyCode == 13) {
        handleTTS(e.target.value);
        e.target.value = "";
      }
    });

    async function handleTTS(message) {
      let tts = {
        voice_name: "智能客服_静静",
        speed: 50,
        volume: 30,
      };
      let data = await _MMFT.loadTTSAndAnimate(message, tts);
      let audio = data[0];
      let teethClip = data[1];
      let emoClip = data[2];
      let teethAction = mixer.clipAction(teethClip);
      let emoAction = mixer.clipAction(emoClip);
      emoAction.loop = THREE.LoopOnce;
      teethAction.loop = THREE.LoopOnce;
      console.log(`teethAction`, teethAction);
      audio.onEnded = () => {
        console.warn(`播放结束`);
        mixer.uncacheAction(teethAction.getClip());
        mixer.uncacheAction(emoAction.getClip());
      };

      while (emos.length) {
        let ea = emos.pop();
        ea.paused = true;
        ea.stop();
      }

      while (audios.length) {
        let lastAudio = audios.pop();
        lastAudio.stop();
      }

      emos.push(emoAction);
      emos.push(teethAction);
      audios.push(audio);
      emoAction.play();
      teethAction.play();
      audio.play();
    }
  </script>
</html>
